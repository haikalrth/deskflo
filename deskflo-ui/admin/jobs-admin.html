<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manajemen Pekerjaan - DeskFlo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc; /* bg-slate-50 */
      }
      .modal-backdrop {
        transition: opacity 0.3s ease;
      }
      .modal-content {
        transition: transform 0.3s ease;
      }
      .dropdown-menu {
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      }
    </style>
  </head>
  <body class="text-slate-800">
    <div class="flex h-screen">
      <aside class="w-64 bg-white shadow-sm flex-shrink-0">
        <div class="p-6 flex items-center space-x-3">
          <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <span class="text-xl font-bold text-slate-800">DeskFlo</span>
        </div>
        <nav class="mt-6 px-4">
          <a href="dashboard-admin.html" class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-100 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
            Dashboard
          </a>
          <a href="programmer-admin.html" class="flex items-center px-4 py-3 mt-2 text-slate-600 hover:bg-slate-100 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path
                d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0112 8a5 5 0 014.5 4.33A6.97 6.97 0 0017 16c0 .34.024.673.07 1h-4.14zM6.07 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 016 8a5 5 0 014.5 4.33A6.97 6.97 0 0011 16c0 .34.024.673.07 1H6.07z"
              />
            </svg>
            Programmer
          </a>
          <a href="team-management-admin.html" class="flex items-center px-4 py-3 mt-2 text-slate-600 hover:bg-slate-100 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v-1h8v1zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 15v-1a4 4 0 00-4-4H8a4 4 0 00-4 4v1h12z" />
            </svg>
            Team Management
          </a>
          <a href="account-approval-admin.html" class="flex items-center justify-between px-4 py-3 mt-2 text-slate-600 hover:bg-slate-100 rounded-lg">
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              Account Approval
            </div>
            <span class="w-5 h-5 bg-rose-500 text-white text-xs font-bold rounded-full flex items-center justify-center">2</span>
          </a>
          <a href="jobs-admin.html" class="flex items-center px-4 py-3 mt-2 bg-slate-100 text-indigo-600 font-semibold rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm0 4a1 1 0 000 2h6a1 1 0 100-2H7zm0 4a1 1 0 000 2h3a1 1 0 100-2H7z" clip-rule="evenodd" />
            </svg>
            Jobs
          </a>
          <a href="calendar-admin.html" class="flex items-center px-4 py-3 mt-2 text-slate-600 hover:bg-slate-100 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V4a1 1 0 10-2 0v1H7V4a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
            </svg>
            Calendar
          </a>
        </nav>
      </aside>

      <main class="flex-1 overflow-y-auto">
        <header class="sticky top-0 z-10 bg-white border-b border-slate-200 p-6 flex justify-between items-center">
          <h1 class="text-xl font-semibold text-slate-900">Manajemen Pekerjaan</h1>
          <div class="flex items-center space-x-5">
            <div class="relative">
              <button id="notification-button" class="text-slate-500 hover:text-slate-800 relative">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                  />
                </svg>
                <span class="absolute -top-1 -right-1 flex h-3 w-3"
                  ><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span
                ></span>
              </button>
              <div id="notification-dropdown" class="dropdown-menu absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg py-1 z-50 hidden opacity-0 transform scale-95">
                <div class="px-4 py-2 font-semibold text-slate-800 border-b">Notifikasi</div>
                <a href="#" class="block px-4 py-3 text-sm text-slate-700 hover:bg-slate-100"
                  ><p class="font-medium">Budi Santoso mengajukan review</p>
                  <p class="text-xs text-slate-500">Tugas: Fixing Bug on Login Page</p></a
                >
              </div>
            </div>
            <div class="relative">
              <div id="profile-button" class="flex items-center space-x-3 cursor-pointer">
                <img class="w-10 h-10 rounded-full object-cover" src="https://placehold.co/100x100/6366f1/ffffff?text=M" alt="Manager Avatar" />
                <div>
                  <p class="font-semibold text-sm">Andi Wijaya</p>
                  <p class="text-xs text-slate-500">Admin</p>
                </div>
              </div>
              <div id="profile-dropdown" class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-1 z-50 hidden opacity-0 transform scale-95">
                <a href="edit-profile-admin.html?from=jobs-admin.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Edit Profil</a>
                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-rose-600 hover:bg-rose-50">Log Out</a>
              </div>
            </div>
          </div>
        </header>
        <div class="p-8 space-y-6">
          <div class="flex justify-end">
            <button id="add-task-button" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center space-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
              </svg>
              <span>Tambah Pekerjaan</span>
            </button>
          </div>
          <div id="tasks-container" class="space-y-6">
            <!-- Data pekerjaan akan dirender di sini oleh JavaScript -->
          </div>
        </div>
      </main>
    </div>

    <div id="add-task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop opacity-0">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl transform scale-95 modal-content">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold">Tambah Pekerjaan Baru</h3>
          <button class="close-modal-button text-slate-500 hover:text-slate-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
          <div>
            <label for="task-name" class="block text-sm font-medium text-slate-700">Judul Pekerjaan</label
            ><input
              type="text"
              id="task-name"
              class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              placeholder="Contoh: Buat halaman profil pengguna"
            />
          </div>
          <div>
            <label for="task-description" class="block text-sm font-medium text-slate-700">Deskripsi</label>
            <div class="relative">
              <textarea
                id="task-description"
                rows="4"
                class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="Jelaskan detail pekerjaan di sini atau buat secara otomatis..."
              ></textarea
              ><button
                id="generate-description-button"
                class="absolute top-2.5 right-2.5 bg-indigo-100 text-indigo-700 text-xs font-semibold px-3 py-1 rounded-full hover:bg-indigo-200 flex items-center space-x-1.5 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span class="text-base leading-none">✨</span>
                <span>Buat Deskripsi Otomatis</span><span id="desc-loader" class="hidden animate-spin rounded-full h-3 w-3 border-b-2 border-indigo-700 ml-1"></span>
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Sub-tugas</label>
            <div class="mt-2 p-4 bg-slate-50 rounded-lg border">
              <div id="subtasks-container" class="space-y-3"><p class="text-sm text-slate-500 text-center">Sub-tugas yang dibuat AI akan muncul di sini.</p></div>
              <button
                id="generate-subtasks-button"
                class="mt-4 w-full bg-emerald-100 text-emerald-700 text-sm font-semibold px-4 py-2 rounded-lg hover:bg-emerald-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span class="text-base leading-none">✨</span>
                <span>Pecah Tugas Menjadi Sub-tugas</span><span id="subtask-loader" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-emerald-700 ml-1"></span>
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Tugaskan Kepada</label>
            <div class="flex items-center space-x-6">
              <div class="flex items-center">
                <input id="assign-individual" name="assignment-type" type="radio" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked /><label
                  for="assign-individual"
                  class="ml-2 block text-sm font-medium text-slate-700"
                  >Individu</label
                >
              </div>
              <div class="flex items-center">
                <input id="assign-team" name="assignment-type" type="radio" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" /><label for="assign-team" class="ml-2 block text-sm font-medium text-slate-700"
                  >Tim Proyek</label
                >
              </div>
            </div>
            <div id="individual-assignment-container" class="mt-2">
              <select class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option>Pilih Programmer</option>
                <option>Budi Santoso (Standby)</option>
                <option>Fahmi Idris (Standby)</option>
              </select>
            </div>
            <div id="team-assignment-container" class="mt-2 hidden">
              <select class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option>Pilih Tim</option>
                <option>Tim Frontend</option>
                <option>Tim API</option>
              </select>
            </div>
          </div>
        </div>
        <div class="p-6 bg-slate-50 rounded-b-2xl flex justify-end space-x-3">
          <button class="close-modal-button bg-white text-slate-700 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">Batal</button
          ><button class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">Simpan Pekerjaan</button>
        </div>
      </div>
    </div>

    <div id="task-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40 hidden modal-backdrop opacity-0">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl transform scale-95 modal-content">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 id="modal-task-title" class="text-xl font-bold">Detail Pekerjaan</h3>
          <button class="close-modal-button text-slate-500 hover:text-slate-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <p class="text-slate-500">Penanggung Jawab</p>
              <div class="flex items-center space-x-2 mt-1">
                <p id="modal-assignee" class="font-semibold">Nama Programmer</p>
              </div>
            </div>
            <div>
              <p class="text-slate-500">Status</p>
              <p id="modal-status" class="font-semibold">Status Tugas</p>
            </div>
          </div>
          <div id="description-container"></div>
          <div id="revision-history-container" class="hidden">
            <label class="block text-sm font-medium text-slate-700">Deskripsi Awal (Sebelum Revisi)</label>
            <p id="modal-original-description" class="mt-1 text-sm text-slate-500 bg-slate-100 p-3 rounded-md border italic"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Sub-tugas</label>
            <div id="modal-subtasks" class="mt-2 space-y-2"></div>
          </div>
          <div id="modal-pr-link-container" class="hidden">
            <label class="block text-sm font-medium text-slate-700">Link Pull Request</label>
            <a id="modal-pr-link" href="#" target="_blank" class="mt-1 text-sm text-indigo-600 hover:underline break-all"></a>
          </div>
        </div>
        <div id="modal-footer-actions" class="p-6 bg-slate-50 rounded-b-2xl flex justify-end space-x-3"></div>
      </div>
    </div>

    <div id="revision-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal-backdrop opacity-0">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg transform scale-95 modal-content">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold">Catatan Revisi</h3>
          <button class="close-modal-button text-slate-500 hover:text-slate-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div class="p-6">
          <label for="revision-notes" class="block text-sm font-medium text-slate-700">Apa yang perlu diperbaiki?</label>
          <textarea
            id="revision-notes"
            rows="4"
            class="mt-2 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            placeholder="Contoh: Tolong perbaiki alignment tombol pada versi mobile..."
          ></textarea>
        </div>
        <div class="p-6 bg-slate-50 rounded-b-2xl flex justify-end space-x-3">
          <button class="close-modal-button bg-white text-slate-700 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">Batal</button>
          <button class="bg-rose-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-rose-700">Kirim Revisi</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { showNotification } from "../notifications.js";

      // --- KONFIGURASI SUPABASE ---
      const SUPABASE_URL = "https://dnyjsrlrfuhmnzuhzrux.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRueWpzcmxyZnVobW56dWh6cnV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDk0MjcsImV4cCI6MjA3MDIyNTQyN30.sK3BqfLMS36-N5lNuED3ehYZ6QbDgkdTpTngKPv20x8";
      let allTasks = [];

      // --- DOM Elements ---
      const tasksContainer = document.getElementById("tasks-container");
      const addTaskModal = document.getElementById("add-task-modal");
      const taskDetailModal = document.getElementById("task-detail-modal");
      const revisionModal = document.getElementById("revision-modal");
      const addTaskButton = document.getElementById("add-task-button");
      const closeModalButtons = document.querySelectorAll(".close-modal-button");
      const profileButton = document.getElementById("profile-button");
      const profileDropdown = document.getElementById("profile-dropdown");
      const notificationButton = document.getElementById("notification-button");
      const notificationDropdown = document.getElementById("notification-dropdown");

      // --- DOM Elements for New Features ---
      const generateDescButton = document.getElementById("generate-description-button");
      const generateSubtasksButton = document.getElementById("generate-subtasks-button");
      const taskNameInput = document.getElementById("task-name");
      const taskDescriptionTextarea = document.getElementById("task-description");
      const subtasksContainer = document.getElementById("subtasks-container");
      const descLoader = document.getElementById("desc-loader");
      const subtaskLoader = document.getElementById("subtask-loader");
      const assignIndividualRadio = document.getElementById("assign-individual");
      const assignTeamRadio = document.getElementById("assign-team");
      const individualAssignmentContainer = document.getElementById("individual-assignment-container");
      const teamAssignmentContainer = document.getElementById("team-assignment-container");

      // --- Status Styling Helper ---
      // --- Helper Functions ---
      function getStatusBadge(status) {
        if (!status) return `<span class="text-xs font-medium bg-slate-100 text-slate-800 px-2 py-0.5 rounded-full">To Do</span>`;

        // Menggunakan toLowerCase() untuk memastikan konsistensi
        switch (status.toLowerCase()) {
          case "in-progress":
            return `<span class="text-xs font-medium bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded-full">In Progress</span>`;
          case "review":
            return `<span class="text-xs font-medium bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full">Review</span>`;
          case "revision":
            return `<span class="text-xs font-medium bg-rose-100 text-rose-800 px-2 py-0.5 rounded-full">Revision</span>`;
          case "completed":
            return `<span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Completed</span>`;
          case "pending":
            return `<span class="text-xs font-medium bg-slate-100 text-slate-800 px-2 py-0.5 rounded-full">Pending</span>`;
          default:
            // Fallback untuk status lain yang mungkin ada
            return `<span class="text-xs font-medium bg-gray-100 text-gray-800 px-2 py-0.5 rounded-full">${status}</span>`;
        }
      }

      // --- RENDER FUNCTIONS ---
      const renderTasks = (tasks) => {
        tasksContainer.innerHTML = ""; // Clear previous content

        if (!tasks || tasks.length === 0) {
          tasksContainer.innerHTML = '<p class="text-center text-slate-500">Tidak ada pekerjaan yang ditemukan.</p>';
          return;
        }

        // Group tasks by project name
        const groupedTasks = tasks.reduce((acc, task) => {
          const key = task.project_name || "Tugas Individual";
          if (!acc[key]) {
            acc[key] = [];
          }
          acc[key].push(task);
          return acc;
        }, {});

        // Render each group
        for (const projectName in groupedTasks) {
          const projectTasks = groupedTasks[projectName];
          const projectElement = document.createElement("div");
          projectElement.className = "bg-white p-6 rounded-xl shadow-sm";

          const teamNames = projectName !== "Tugas Individual" ? [...new Set(projectTasks.map((t) => t.team_name).filter(Boolean))].join(", ") : "";

          let tableRows = "";
          projectTasks.forEach((task) => {
            const actionButtonText = task.status === "Menunggu Review" ? "Tinjau" : "Detail";
            tableRows += `
              <tr class="border-b border-slate-100">
                <td class="py-3 pr-4 font-medium">${task.title}</td>
                <td class="py-3 px-4">${task.assignee_name || "-"}</td>
                <td class="py-3 px-4">${getStatusBadge(task.status)}</td>
                <td class="py-3 pl-4">
                  <button class="task-action-button font-medium text-indigo-600 hover:underline" data-task-id="${task.id}">${actionButtonText}</button>
                </td>
              </tr>
            `;
          });

          projectElement.innerHTML = `
            <h3 class="text-lg font-bold">${projectName}</h3>
            ${teamNames ? `<p class="text-sm text-slate-500">Ditugaskan ke: ${teamNames}</p>` : ""}
            <div class="mt-4">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-slate-500 uppercase">
                  <tr>
                    <th class="py-2 pr-4">Tugas</th>
                    <th class="py-2 px-4">Penanggung Jawab</th>
                    <th class="py-2 px-4">Status</th>
                    <th class="py-2 pl-4">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  ${tableRows}
                </tbody>
              </table>
            </div>
          `;
          tasksContainer.appendChild(projectElement);
        }
      };

      // --- FETCH DATA ---
      async function fetchTasks() {
        tasksContainer.innerHTML = '<p class="text-center text-slate-500">Memuat data pekerjaan...</p>';
        try {
          // Menggunakan URL functions yang benar sesuai instruksi
          const response = await fetch("https://dnyjsrlrfuhmnzuhzrux.functions.supabase.co/get-tasks", {
            headers: {
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
          });

          // Logging untuk debugging
          console.log("Fetch response:", response);
          if (!response.ok) {
            const errorText = await response.text();
            console.error("Error response body:", errorText);
            throw new Error(`Gagal mengambil data. Status: ${response.status}`);
          }

          allTasks = await response.json();
          // Logging untuk debugging
          console.log("Data pekerjaan berhasil diambil:", allTasks);
          renderTasks(allTasks);
        } catch (error) {
          console.error("Error fetching tasks:", error);
          tasksContainer.innerHTML = `<p class="text-center text-red-500">Gagal memuat data: ${error.message}</p>`;
        }
      }

      // --- Modal Management ---
      const openModal = (modal) => {
        modal.classList.remove("hidden");
        setTimeout(() => {
          modal.classList.remove("opacity-0");
          modal.querySelector(".modal-content").classList.remove("scale-95");
        }, 10);
      };

      const closeModal = (modal) => {
        if (modal) {
          modal.classList.add("opacity-0");
          modal.querySelector(".modal-content").classList.add("scale-95");
          setTimeout(() => modal.classList.add("hidden"), 300);
        }
      };

      // --- Dropdown Logic ---
      function closeDropdown(dropdown) {
        if (dropdown && !dropdown.classList.contains("hidden")) {
          dropdown.classList.add("opacity-0", "scale-95");
          setTimeout(() => dropdown.classList.add("hidden"), 200);
        }
      }

      function toggleDropdown(dropdownToToggle) {
        const isHidden = dropdownToToggle.classList.contains("hidden");
        const currentlyOpenDropdown = profileDropdown === dropdownToToggle ? notificationDropdown : profileDropdown;
        closeDropdown(currentlyOpenDropdown);
        if (isHidden) {
          dropdownToToggle.classList.remove("hidden");
          setTimeout(() => {
            dropdownToToggle.classList.remove("opacity-0", "scale-95");
          }, 10);
        } else {
          closeDropdown(dropdownToToggle);
        }
      }

      function closeAllDropdowns() {
        closeDropdown(profileDropdown);
        closeDropdown(notificationDropdown);
      }

      // --- Task Detail Modal Logic ---
      function openAndPopulateTaskModal(taskId) {
        const task = allTasks.find((t) => t.id == taskId);
        if (!task) {
          console.error("Task not found:", taskId);
          showNotification("Tugas tidak ditemukan.", "error");
          return;
        }

        document.getElementById("modal-task-title").textContent = task.title;
        document.getElementById("modal-assignee").textContent = task.assignee_name || "Belum Ditugaskan";
        document.getElementById("modal-status").textContent = task.status;

        const descriptionContainer = document.getElementById("description-container");
        descriptionContainer.innerHTML = `
            <label class="block text-sm font-medium text-slate-700">Deskripsi</label>
            <p class="mt-1 text-sm text-slate-600 bg-slate-50 p-3 rounded-md border">${task.description || "-"}</p>
        `;

        const revisionContainer = document.getElementById("revision-history-container");
        if (task.original_description) {
          document.getElementById("modal-original-description").textContent = task.original_description;
          revisionContainer.classList.remove("hidden");
        } else {
          revisionContainer.classList.add("hidden");
        }

        const subtasks = task.subtasks || [];
        const subtasksHtml =
          subtasks.length > 0
            ? subtasks
                .map(
                  (sub) =>
                    `<div class="flex items-center">
                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${sub.completed ? "checked" : ""} disabled>
                <label class="ml-3 text-sm text-slate-800 ${sub.completed ? "line-through text-slate-500" : ""}">${sub.text}</label>
            </div>`
                )
                .join("")
            : '<p class="text-sm text-slate-500">Tidak ada sub-tugas.</p>';
        document.getElementById("modal-subtasks").innerHTML = subtasksHtml;

        const prLinkContainer = document.getElementById("modal-pr-link-container");
        const footerActions = document.getElementById("modal-footer-actions");
        if (task.status === "Menunggu Review") {
          const prLink = document.getElementById("modal-pr-link");
          prLink.href = task.pr_link || "#";
          prLink.textContent = task.pr_link || "Tidak ada link";
          prLinkContainer.classList.remove("hidden");

          footerActions.innerHTML = `
                <button id="request-revision-button" class="bg-rose-100 text-rose-700 font-semibold px-4 py-2 rounded-lg hover:bg-rose-200">Minta Revisi</button>
                <button class="bg-emerald-100 text-emerald-700 font-semibold px-4 py-2 rounded-lg hover:bg-emerald-200">Setujui</button>
            `;
          document.getElementById("request-revision-button").addEventListener("click", () => openModal(revisionModal));
        } else {
          prLinkContainer.classList.add("hidden");
          footerActions.innerHTML = "";
        }

        openModal(taskDetailModal);
      }

      // --- EVENT LISTENERS ---
      document.addEventListener("DOMContentLoaded", function () {
        fetchTasks();

        // Modals
        if (addTaskButton) {
          addTaskButton.addEventListener("click", () => openModal(addTaskModal));
        }
        closeModalButtons.forEach((button) => {
          button.addEventListener("click", (e) => {
            const modalToClose = e.target.closest(".modal-backdrop");
            if (modalToClose) closeModal(modalToClose);
          });
        });

        // Dropdowns
        profileButton.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleDropdown(profileDropdown);
        });
        notificationButton.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleDropdown(notificationDropdown);
        });
        window.addEventListener("click", closeAllDropdowns);

        // Logout
        const logoutButton = document.getElementById("logout-button");
        if (logoutButton) {
          logoutButton.addEventListener("click", (e) => {
            e.preventDefault();
            console.log("Logging out...");
            window.location.href = "../authentication.html?status=logout_success";
          });
        }

        // Event Delegation for Task Actions
        tasksContainer.addEventListener("click", (e) => {
          const target = e.target;
          if (target.classList.contains("task-action-button")) {
            const taskId = target.dataset.taskId;
            openAndPopulateTaskModal(taskId);
          }
        });

        // --- New Features Logic (Existing) ---
        const handleAssignmentTypeChange = () => {
          if (assignTeamRadio.checked) {
            teamAssignmentContainer.classList.remove("hidden");
            individualAssignmentContainer.classList.add("hidden");
          } else {
            individualAssignmentContainer.classList.remove("hidden");
            teamAssignmentContainer.classList.add("hidden");
          }
        };
        assignIndividualRadio.addEventListener("change", handleAssignmentTypeChange);
        assignTeamRadio.addEventListener("change", handleAssignmentTypeChange);

        generateDescButton.addEventListener("click", async () => {
          const taskTitle = taskNameInput.value.trim();
          if (!taskTitle) {
            showNotification("Harap isi Judul Pekerjaan terlebih dahulu.", "error");
            return;
          }
          descLoader.classList.remove("hidden");
          generateDescButton.disabled = true;
          try {
            const prompt = `Sebagai seorang manajer proyek yang berpengalaman, buatkan deskripsi pekerjaan yang jelas dan ringkas untuk judul pekerjaan berikut: "${taskTitle}". Deskripsi harus mencakup tujuan utama dari tugas tersebut.`;
            const result = await callGeminiAPI(prompt);
            taskDescriptionTextarea.value = result;
          } catch (error) {
            console.error("Error generating description:", error);
            showNotification("Gagal membuat deskripsi. Silakan coba lagi.", "error");
          } finally {
            descLoader.classList.add("hidden");
            generateDescButton.disabled = false;
          }
        });

        generateSubtasksButton.addEventListener("click", async () => {
          const taskTitle = taskNameInput.value.trim();
          const taskDescription = taskDescriptionTextarea.value.trim();
          if (!taskTitle || !taskDescription) {
            showNotification("Harap isi Judul Pekerjaan dan Deskripsi terlebih dahulu.", "error");
            return;
          }
          subtaskLoader.classList.remove("hidden");
          generateSubtasksButton.disabled = true;
          try {
            const prompt = `Sebagai seorang manajer proyek, pecah pekerjaan berikut menjadi sub-tugas yang actionable dalam bentuk list. Judul: ${taskTitle}. Deskripsi: ${taskDescription}. Berikan jawaban dalam format array javascript.`;
            const result = await callGeminiAPI(prompt);
            if (Array.isArray(result) && result.length > 0) {
              subtasksContainer.innerHTML = "";
              result.forEach((subtaskText) => {
                const subtaskElement = document.createElement("div");
                subtaskElement.className = "flex items-center space-x-3 bg-white p-2.5 rounded-md border shadow-sm";
                subtaskElement.innerHTML = `
                  <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer flex-shrink-0">
                  <input type="text" value="${subtaskText}" class="text-sm text-slate-800 flex-grow bg-transparent focus:outline-none focus:ring-0 border-0 p-0">
                  <button class="remove-subtask-btn text-slate-400 hover:text-rose-500 flex-shrink-0">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                `;
                subtasksContainer.appendChild(subtaskElement);
              });
            } else {
              subtasksContainer.innerHTML = '<p class="text-sm text-slate-500 text-center">Tidak ada sub-tugas yang dapat dibuat.</p>';
            }
          } catch (error) {
            console.error("Error generating subtasks:", error);
            subtasksContainer.innerHTML = '<p class="text-sm text-red-500 text-center">Gagal membuat sub-tugas. Silakan coba lagi.</p>';
          } finally {
            subtaskLoader.classList.add("hidden");
            generateSubtasksButton.disabled = false;
          }
        });

        subtasksContainer.addEventListener("click", function (e) {
          const removeButton = e.target.closest(".remove-subtask-btn");
          if (removeButton) {
            removeButton.closest(".flex").remove();
            if (subtasksContainer.children.length === 0) {
              subtasksContainer.innerHTML = '<p class="text-sm text-slate-500 text-center">Sub-tugas yang dibuat AI akan muncul di sini.</p>';
            }
          }
        });
      });

      // --- Mock Gemini API Integration (Existing) ---
      const callGeminiAPI = (prompt) => {
        console.log("Memanggil Mock Gemini API dengan prompt:", prompt);
        return new Promise((resolve) => {
          setTimeout(() => {
            if (prompt.includes("buatkan deskripsi pekerjaan")) {
              const description =
                "Tugas ini berfokus pada pembuatan halaman profil pengguna yang fungsional dan responsif. Halaman ini harus menampilkan informasi dasar pengguna seperti nama, email, dan foto profil. Selain itu, perlu ada fungsionalitas untuk mengedit informasi tersebut. Pastikan desain sesuai dengan mock-up yang telah disediakan di Figma dan implementasikan validasi pada setiap input form.";
              resolve(description);
            } else if (prompt.includes("pecah pekerjaan berikut menjadi sub-tugas")) {
              const subtasks = [
                "Buat struktur HTML dasar untuk halaman profil.",
                "Implementasikan styling CSS menggunakan Tailwind CSS sesuai desain Figma.",
                "Buat komponen form untuk edit profil.",
                "Hubungkan form dengan state management untuk menangani input pengguna.",
                "Implementasikan logika untuk upload foto profil.",
                "Tambahkan validasi input untuk form edit (email, nama).",
                "Lakukan testing responsivitas pada berbagai ukuran layar (mobile, tablet, desktop).",
              ];
              resolve(subtasks);
            } else {
              resolve("Maaf, saya tidak mengerti permintaan Anda.");
            }
          }, 1500);
        });
      };
    </script>
  </body>
</html>
