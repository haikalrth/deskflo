<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daftar Programmer - DeskFlo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc; /* bg-slate-50 */
      }
      .modal-backdrop {
        transition: opacity 0.3s ease;
      }
      .modal-content {
        transition: transform 0.3s ease;
      }
      .dropdown-menu {
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      }
    </style>
  </head>
  <body class="text-slate-800">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-white shadow-sm flex-shrink-0">
        <div class="p-6 flex items-center space-x-3">
          <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <span class="text-xl font-bold text-slate-800">DeskFlo</span>
        </div>
        <nav class="mt-6 px-4">
          <a href="dashboard-admin.html" class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-100 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
            Dashboard
          </a>
          <a href="programmer-admin.html" class="flex items-center px-4 py-3 mt-2 bg-slate-100 text-indigo-600 font-semibold rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path
                d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0112 8a5 5 0 014.5 4.33A6.97 6.97 0 0017 16c0 .34.024.673.07 1h-4.14zM6.07 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 016 8a5 5 0 014.5 4.33A6.97 6.97 0 0011 16c0 .34.024.673.07 1H6.07z"
              />
            </svg>
            Programmer
          </a>
          <a href="team-management-admin.html" class="flex items-center px-4 py-3 mt-2 text-slate-600 hover:bg-slate-100 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v-1h8v1zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 15v-1a4 4 0 00-4-4H8a4 4 0 00-4 4v1h12z" />
            </svg>
            Team Management
          </a>
          <a href="account-approval-admin.html" class="flex items-center justify-between px-4 py-3 mt-2 text-slate-600 hover:bg-slate-100 rounded-lg">
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              Account Approval
            </div>
            <span id="approval-count" class="w-5 h-5 bg-rose-500 text-white text-xs font-bold rounded-full flex items-center justify-center">...</span>
          </a>
          <a href="jobs-admin.html" class="flex items-center px-4 py-3 mt-2 text-slate-600 hover:bg-slate-100 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 000 2h6a1 1 0 100-2H7zm0 4a1 1 0 000 2h6a1 1 0 100-2H7zm0 4a1 1 0 000 2h3a1 1 0 100-2H7z" clip-rule="evenodd" />
            </svg>
            Jobs
          </a>
          <a href="calendar-admin.html" class="flex items-center px-4 py-3 mt-2 text-slate-600 hover:bg-slate-100 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V4a1 1 0 10-2 0v1H7V4a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
            </svg>
            Calendar
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 overflow-y-auto">
        <header class="sticky top-0 z-10 bg-white border-b border-slate-200 p-6 flex justify-between items-center">
          <h1 class="text-xl font-semibold text-slate-900">Daftar Programmer</h1>
          <div class="flex items-center space-x-5">
            <div class="relative">
              <button id="notification-button" class="text-slate-500 hover:text-slate-800 relative">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                  />
                </svg>
                <span class="absolute -top-1 -right-1 flex h-3 w-3"
                  ><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span
                ></span>
              </button>
              <div id="notification-dropdown" class="dropdown-menu absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg py-1 z-50 hidden opacity-0 transform scale-95">
                <div class="px-4 py-2 font-semibold text-slate-800 border-b">Notifikasi</div>
                <a href="#" class="block px-4 py-3 text-sm text-slate-700 hover:bg-slate-100"
                  ><p class="font-medium">Budi Santoso mengajukan review</p>
                  <p class="text-xs text-slate-500">Tugas: Fixing Bug on Login Page</p></a
                >
              </div>
            </div>
            <div class="relative">
              <div id="profile-button" class="flex items-center space-x-3 cursor-pointer">
                <img id="topbar-user-avatar" class="w-10 h-10 rounded-full object-cover" src="https://placehold.co/100x100/6366f1/ffffff?text=U" alt="User Avatar" />
                <div>
                  <p id="topbar-user-name" class="font-semibold text-sm">Nama Pengguna</p>
                  <p id="topbar-user-role" class="text-xs text-slate-500">Role</p>
                </div>
              </div>
              <div id="profile-dropdown" class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-1 z-50 hidden opacity-0 transform scale-95">
                <a href="edit-profile-admin.html?from=programmer-admin.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Edit Profil</a>
                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-rose-600 hover:bg-rose-50">Log Out</a>
              </div>
            </div>
          </div>
        </header>
        <div class="p-8">
          <div class="flex justify-end mb-6 space-x-3">
            <button id="export-csv-button" class="bg-white text-slate-700 border border-slate-300 font-semibold px-4 py-2 rounded-lg hover:bg-slate-50 flex items-center space-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path
                  fill-rule="evenodd"
                  d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>Export CSV</span>
            </button>
            <button id="add-programmer-button" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center space-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg
              ><span>Tambah Programmer</span>
            </button>
          </div>
          <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <input id="search-input" type="text" placeholder="Cari nama atau NPM..." class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
              <select id="team-filter" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">Semua Tim</option>
              </select>
              <select id="status-filter" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">Semua Status</option>
                <option>On Task</option>
                <option>Standby</option>
                <option>On Leave</option>
              </select>
              <button id="apply-filter-button" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">Terapkan Filter</button>
            </div>
          </div>
          <div class="w-full">
            <div class="grid grid-cols-7 gap-4 px-6 py-3 text-xs font-semibold text-slate-500 uppercase">
              <div class="col-span-1">Nama</div>
              <div class="col-span-1">NPM</div>
              <div class="col-span-1">Jurusan</div>
              <div class="col-span-1">Tim</div>
              <div class="col-span-1">Status</div>
              <div class="col-span-1">Tugas Aktif</div>
              <div class="col-span-1 text-center">Aksi</div>
            </div>
            <div id="programmer-table-body" class="mt-2 space-y-2">
              <!-- Data akan diisi oleh JavaScript -->
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Add/Edit Programmer Modal -->
    <div id="programmer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop opacity-0">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg transform scale-95 modal-content">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 id="modal-title" class="text-xl font-bold">Tambah Programmer Baru</h3>
          <button class="close-modal-button text-slate-500 hover:text-slate-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <form id="programmer-form">
          <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
            <input type="hidden" id="programmer-id" />
            <div>
              <label for="nama" class="block text-sm font-medium text-slate-700">Nama Lengkap</label
              ><input
                type="text"
                id="nama"
                name="nama_lengkap"
                required
                class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              />
            </div>
            <div>
              <label for="npm" class="block text-sm font-medium text-slate-700">NPM</label
              ><input type="text" id="npm" name="npm" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
            </div>
            <div>
              <label for="jurusan" class="block text-sm font-medium text-slate-700">Jurusan</label
              ><input type="text" id="jurusan" name="jurusan" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-slate-700">Alamat Email</label
              ><input type="email" id="email" name="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
            </div>
            <div>
              <label for="role" class="block text-sm font-medium text-slate-700">Peran (Role)</label>
              <select id="role" name="role" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option>Programmer</option>
                <option>Admin</option>
              </select>
            </div>
          </div>
          <div class="p-6 bg-slate-50 rounded-b-2xl flex justify-end space-x-3">
            <button type="button" class="close-modal-button bg-white text-slate-700 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">Batal</button>
            <button id="modal-submit-button" type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700">Kirim Undangan</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop opacity-0">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-md transform scale-95 modal-content">
        <div class="p-6">
          <div class="text-center">
            <svg class="mx-auto h-12 w-12 text-rose-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
              />
            </svg>
            <h3 class="mt-2 text-lg font-semibold text-slate-800">Hapus Programmer</h3>
            <p id="delete-confirmation-text" class="mt-2 text-sm text-slate-500">Tindakan ini tidak dapat dibatalkan. Mohon ketik nama programmer untuk konfirmasi.</p>
          </div>
          <div class="mt-4">
            <input type="text" id="delete-confirmation-input" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-rose-500 focus:border-rose-500 sm:text-sm" />
          </div>
        </div>
        <div class="p-6 bg-slate-50 rounded-b-2xl flex justify-center space-x-3">
          <button class="close-delete-modal-button bg-white text-slate-700 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100">Batal</button>
          <button id="confirm-delete-button" class="bg-rose-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-rose-700 disabled:bg-rose-300 disabled:cursor-not-allowed" disabled>Ya, Hapus</button>
        </div>
      </div>
    </div>

    <!-- Active Tasks Modal -->
    <div id="active-tasks-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop opacity-0">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg transform scale-95 modal-content">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 id="active-tasks-title" class="text-xl font-bold">Tugas Aktif: Nama Programmer</h3>
          <button class="close-modal-button text-slate-500 hover:text-slate-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div id="active-tasks-list" class="p-6 space-y-3 max-h-[60vh] overflow-y-auto">
          <!-- Daftar tugas akan diisi oleh JavaScript -->
        </div>
      </div>
    </div>

    <script type="module" src="../shared-ui.js"></script>

    <script type="module">
      import { showNotification } from "../notifications.js";
      import { handleLogout } from "../shared-ui.js";

      // --- KONFIGURASI SUPABASE ---
      const SUPABASE_URL = "https://dnyjsrlrfuhmnzuhzrux.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRueWpzcmxyZnVobW56dWh6cnV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDk0MjcsImV4cCI6MjA3MDIyNTQyN30.sK3BqfLMS36-N5lNuED3ehYZ6QbDgkdTpTngKPv20x8";
      let allProgrammers = [];
      let allTeams = [];
      let allTasks = [];
      let currentProgrammerIdToDelete = null;

      // --- FUNGSI FETCH DATA ---
      async function fetchInitialData() {
        const tableBody = document.getElementById("programmer-table-body");
        tableBody.innerHTML = '<div class="text-center p-8 text-slate-500 col-span-full">Memuat data...</div>';
        try {
          // Ambil semua data yang diperlukan secara bersamaan
          const [programmersResponse, teamsResponse, tasksResponse] = await Promise.all([
            fetch(`${SUPABASE_URL}/functions/v1/get-programmers`, { headers: { Authorization: `Bearer ${SUPABASE_ANON_KEY}`, apikey: SUPABASE_ANON_KEY } }),
            fetch(`${SUPABASE_URL}/functions/v1/get-teams`, { headers: { Authorization: `Bearer ${SUPABASE_ANON_KEY}`, apikey: SUPABASE_ANON_KEY } }),
            fetch(`${SUPABASE_URL}/functions/v1/get-tasks`, { headers: { Authorization: `Bearer ${SUPABASE_ANON_KEY}`, apikey: SUPABASE_ANON_KEY } }),
          ]);

          if (!programmersResponse.ok) throw new Error("Gagal mengambil data programmer");
          if (!teamsResponse.ok) throw new Error("Gagal mengambil data tim");
          if (!tasksResponse.ok) throw new Error("Gagal mengambil data tugas");

          allProgrammers = await programmersResponse.json();
          allTeams = await teamsResponse.json();
          allTasks = await tasksResponse.json();

          // Setelah semua data ada, render tabel dan filter
          populateTeamFilter();
          renderProgrammerTable(allProgrammers);
        } catch (error) {
          console.error("Error fetching initial data:", error);
          tableBody.innerHTML = `<div class="text-center p-8 text-red-500 col-span-full">Gagal memuat data: ${error.message}</div>`;
        }
      }

      // --- FUNGSI UNTUK MENGISI FILTER TIM ---
      function populateTeamFilter() {
        const teamFilter = document.getElementById("team-filter");
        teamFilter.innerHTML = '<option value="">Semua Tim</option>';
        allTeams.forEach((team) => {
          const option = document.createElement("option");
          option.value = team.id;
          option.textContent = team.nama_tim;
          teamFilter.appendChild(option);
        });
      }

      // --- FUNGSI BANTUAN UNTUK STATUS BADGE ---
      function getProgrammerStatusBadge(status) {
        if (!status) {
          return `<span class="flex items-center text-slate-500"><span class="h-2 w-2 rounded-full bg-slate-400 mr-2"></span>Standby</span>`;
        }
        switch (status.toLowerCase()) {
          case "on task":
            return `<span class="flex items-center text-green-800"><span class="h-2 w-2 rounded-full bg-green-500 mr-2"></span>On Task</span>`;
          case "on leave":
            return `<span class="flex items-center text-amber-800"><span class="h-2 w-2 rounded-full bg-amber-500 mr-2"></span>On Leave</span>`;
          case "standby":
          default:
            return `<span class="flex items-center text-slate-500"><span class="h-2 w-2 rounded-full bg-slate-400 mr-2"></span>Standby</span>`;
        }
      }

      // --- FUNGSI UNTUK MERENDER TABEL ---
      function renderProgrammerTable(dataToRender) {
        const tableBody = document.getElementById("programmer-table-body");
        tableBody.innerHTML = "";
        if (dataToRender.length === 0) {
          tableBody.innerHTML = '<div class="text-center p-8 text-slate-500 col-span-full">Tidak ada data programmer yang ditemukan.</div>';
          return;
        }
        dataToRender.forEach((p) => {
          const row = document.createElement("div");
          row.className = "grid grid-cols-7 gap-4 items-center bg-white p-4 rounded-lg shadow-sm border border-slate-200";

          // Hitung tugas aktif untuk programmer saat ini
          const activeTasksCount = allTasks.filter((task) => task.assignee_name === p.nama_lengkap && task.status !== "Completed").length;

          // Tentukan status berdasarkan tugas aktif
          const currentStatus = activeTasksCount > 0 ? "On Task" : "Standby";

          // Cari tim untuk programmer saat ini
          const programmerTeams = allTeams.filter((team) => team.members.some((member) => member.id === p.id));
          const teamTags =
            programmerTeams.length > 0
              ? programmerTeams.map((team) => `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800">${team.nama_tim}</span>`).join(" ")
              : '<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-gray-100 text-gray-800">-</span>';

          const statusHtml = getProgrammerStatusBadge(currentStatus);
          const taskHtml =
            activeTasksCount > 0
              ? `<button class="font-semibold text-slate-800 hover:text-indigo-600 active-tasks-button" data-programmer-name="${p.nama_lengkap}">${activeTasksCount} Tugas</button>`
              : '<span class="text-slate-400">-</span>';

          row.innerHTML = `
            <div class="col-span-1 font-semibold text-slate-900">${p.nama_lengkap}</div>
            <div class="col-span-1 text-slate-600">${p.npm}</div>
            <div class="col-span-1 text-slate-600">${p.jurusan}</div>
            <div class="col-span-1 flex flex-wrap gap-1">${teamTags}</div>
            <div class="col-span-1">${statusHtml}</div>
            <div class="col-span-1">${taskHtml}</div>
            <div class="col-span-1 text-center space-x-3">
              <button class="font-medium text-slate-600 hover:underline edit-programmer-button" data-programmer-id="${p.id}">Edit</button>
              <button class="font-medium text-rose-600 hover:underline delete-programmer-button" data-programmer-id="${p.id}">Hapus</button>
            </div>
          `;
          tableBody.appendChild(row);
        });
        attachActionListeners();
      }

      // --- LOGIKA FILTER ---
      function applyFilters() {
        const searchTerm = document.getElementById("search-input").value.toLowerCase();
        const selectedTeamId = document.getElementById("team-filter").value;
        // PERUBAHAN: Ambil nilai dari filter status
        const selectedStatus = document.getElementById("status-filter").value;

        let filteredData = allProgrammers;

        // Filter berdasarkan pencarian nama/npm
        if (searchTerm) {
          filteredData = filteredData.filter((p) => p.nama_lengkap.toLowerCase().includes(searchTerm) || p.npm.includes(searchTerm));
        }

        // Filter berdasarkan tim
        if (selectedTeamId) {
          filteredData = filteredData.filter((p) => {
            return allTeams.some((team) => team.id == selectedTeamId && team.members.some((member) => member.id === p.id));
          });
        }

        // PERUBAHAN: Tambahkan logika filter berdasarkan status
        if (selectedStatus) {
          filteredData = filteredData.filter((p) => {
            const activeTasksCount = allTasks.filter((task) => task.assignee_name === p.nama_lengkap && task.status !== "Completed").length;

            const currentStatus = activeTasksCount > 0 ? "On Task" : "Standby";

            // Jika user memilih "On Leave", kita filter programmer yang statusnya bukan "On Task" atau "Standby"
            // Saat ini, logika ini tidak akan mengembalikan apa-apa karena data 'On Leave' belum ada.
            if (selectedStatus === "On Leave") {
              return currentStatus !== "On Task" && currentStatus !== "Standby";
            }

            return currentStatus === selectedStatus;
          });
        }

        renderProgrammerTable(filteredData);
      }

      document.getElementById("apply-filter-button").addEventListener("click", applyFilters);
      document.getElementById("search-input").addEventListener("keyup", (event) => {
        if (event.key === "Enter") applyFilters();
      });

      // --- LOGIKA EXPORT CSV ---
      function exportToCSV() {
        const headers = ["Nama Lengkap", "NPM", "Jurusan", "Email", "Role", "Tim"];
        const csvRows = [headers.join(",")];

        allProgrammers.forEach((p) => {
          const programmerTeams = allTeams
            .filter((team) => team.members.some((member) => member.id === p.id))
            .map((team) => team.nama_tim)
            .join("; ");

          const row = [`"${p.nama_lengkap}"`, `"${p.npm}"`, `"${p.jurusan || ""}"`, `"${p.email}"`, `"${p.role}"`, `"${programmerTeams || ""}"`];
          csvRows.push(row.join(","));
        });

        const csvString = csvRows.join("\n");
        const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "daftar_programmer.csv");
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      document.getElementById("export-csv-button").addEventListener("click", exportToCSV);

      // --- LOGIKA MODAL ---
      const programmerModal = document.getElementById("programmer-modal");
      const deleteModal = document.getElementById("delete-modal");
      const activeTasksModal = document.getElementById("active-tasks-modal");
      const addProgrammerButton = document.getElementById("add-programmer-button");
      const closeModalButtons = document.querySelectorAll(".close-modal-button");
      const closeDeleteModalButton = document.querySelector(".close-delete-modal-button");
      const programmerForm = document.getElementById("programmer-form");
      const modalTitle = document.getElementById("modal-title");
      const modalSubmitButton = document.getElementById("modal-submit-button");
      const programmerIdInput = document.getElementById("programmer-id");
      const emailInput = document.getElementById("email");
      const confirmDeleteButton = document.getElementById("confirm-delete-button");
      const deleteConfirmationText = document.getElementById("delete-confirmation-text");
      const deleteConfirmationInput = document.getElementById("delete-confirmation-input");

      const openModal = (modal) => {
        modal.classList.remove("hidden");
        setTimeout(() => {
          modal.classList.remove("opacity-0");
          modal.querySelector(".modal-content").classList.remove("scale-95");
        }, 10);
      };

      const closeModal = (modal) => {
        modal.classList.add("opacity-0");
        modal.querySelector(".modal-content").classList.add("scale-95");
        setTimeout(() => modal.classList.add("hidden"), 300);
      };

      closeModalButtons.forEach((button) => {
        button.addEventListener("click", (e) => {
          const modalToClose = e.target.closest(".modal-backdrop");
          if (modalToClose) closeModal(modalToClose);
        });
      });
      closeDeleteModalButton.addEventListener("click", () => closeModal(deleteModal));

      addProgrammerButton.addEventListener("click", () => {
        programmerForm.reset();
        programmerIdInput.value = "";
        modalTitle.textContent = "Tambah Programmer Baru";
        modalSubmitButton.textContent = "Kirim Undangan";
        emailInput.disabled = false;
        openModal(programmerModal);
      });

      function attachActionListeners() {
        // Attach listeners for Edit buttons
        document.querySelectorAll(".edit-programmer-button").forEach((button) => {
          button.addEventListener("click", () => {
            const programmerId = button.dataset.programmerId;
            const programmer = allProgrammers.find((p) => p.id == programmerId);
            if (programmer) {
              programmerForm.reset();
              modalTitle.textContent = `Edit Data: ${programmer.nama_lengkap}`;
              modalSubmitButton.textContent = "Simpan Perubahan";

              programmerIdInput.value = programmer.id;
              document.getElementById("nama").value = programmer.nama_lengkap;
              document.getElementById("npm").value = programmer.npm;
              document.getElementById("jurusan").value = programmer.jurusan;
              emailInput.value = programmer.email;
              emailInput.disabled = true;
              document.getElementById("role").value = programmer.role;

              openModal(programmerModal);
            }
          });
        });

        // Attach listeners for Delete buttons
        document.querySelectorAll(".delete-programmer-button").forEach((button) => {
          button.addEventListener("click", () => {
            currentProgrammerIdToDelete = button.dataset.programmerId;
            const programmer = allProgrammers.find((p) => p.id == currentProgrammerIdToDelete);
            if (programmer) {
              deleteConfirmationText.innerHTML = `Tindakan ini tidak dapat dibatalkan. Mohon ketik <strong class="text-slate-800">${programmer.nama_lengkap}</strong> untuk konfirmasi.`;
              confirmDeleteButton.dataset.programmerName = programmer.nama_lengkap;
              deleteConfirmationInput.value = "";
              confirmDeleteButton.disabled = true;
              openModal(deleteModal);
            }
          });
        });

        // Listener untuk tombol Tugas Aktif
        document.querySelectorAll(".active-tasks-button").forEach((button) => {
          button.addEventListener("click", () => {
            const programmerName = button.dataset.programmerName;
            const tasks = allTasks.filter((t) => t.assignee_name === programmerName && t.status !== "Completed");

            document.getElementById("active-tasks-title").textContent = `Tugas Aktif: ${programmerName}`;
            const taskList = document.getElementById("active-tasks-list");
            taskList.innerHTML = "";

            if (tasks.length > 0) {
              tasks.forEach((task) => {
                const taskElement = document.createElement("div");
                taskElement.className = "bg-slate-100 p-3 rounded-lg";
                taskElement.innerHTML = `
                                <p class="font-semibold text-slate-800">${task.title}</p>
                                <p class="text-sm text-slate-500">Proyek: ${task.project_name || "Tugas Individual"}</p>
                                `;
                taskList.appendChild(taskElement);
              });
            } else {
              taskList.innerHTML = '<p class="text-slate-500">Tidak ada tugas aktif.</p>';
            }

            openModal(activeTasksModal);
          });
        });
      }

      // --- FORM SUBMISSION LOGIC (CREATE/UPDATE) ---
      programmerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(programmerForm);
        const data = Object.fromEntries(formData.entries());
        const programmerId = programmerIdInput.value;

        const isUpdating = !!programmerId;
        const endpoint = isUpdating ? "update-programmer" : "create-programmer";

        if (isUpdating) {
          data.email = emailInput.value;
        }

        const body = isUpdating ? { ...data, programmerId } : data;

        modalSubmitButton.disabled = true;
        const originalButtonText = modalSubmitButton.innerHTML;
        modalSubmitButton.innerHTML = `<span class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mx-auto"></span>`;

        try {
          const response = await fetch(`${SUPABASE_URL}/functions/v1/${endpoint}`, {
            method: "POST",
            headers: { Authorization: `Bearer ${SUPABASE_ANON_KEY}`, apikey: SUPABASE_ANON_KEY, "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.error || "Terjadi kesalahan");

          showNotification(result.message, "success");
          fetchInitialData();
          closeModal(programmerModal);
        } catch (error) {
          showNotification(`Gagal: ${error.message}`, "error");
        } finally {
          modalSubmitButton.disabled = false;
          modalSubmitButton.innerHTML = originalButtonText;
        }
      });

      // --- DELETE CONFIRMATION LOGIC ---
      deleteConfirmationInput.addEventListener("input", (e) => {
        confirmDeleteButton.disabled = e.target.value !== confirmDeleteButton.dataset.programmerName;
      });

      confirmDeleteButton.addEventListener("click", async () => {
        if (!currentProgrammerIdToDelete) return;

        confirmDeleteButton.disabled = true;
        const originalButtonText = confirmDeleteButton.innerHTML;
        confirmDeleteButton.innerHTML = `<span class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mx-auto"></span>`;

        try {
          const response = await fetch(`${SUPABASE_URL}/functions/v1/delete-programmer`, {
            method: "POST",
            headers: { Authorization: `Bearer ${SUPABASE_ANON_KEY}`, apikey: SUPABASE_ANON_KEY, "Content-Type": "application/json" },
            body: JSON.stringify({ programmerId: currentProgrammerIdToDelete }),
          });

          const result = await response.json();
          if (!response.ok) throw new Error(result.error || "Gagal menghapus programmer.");

          showNotification(result.message, "success");
          fetchInitialData();
          closeModal(deleteModal);
        } catch (error) {
          showNotification(`Gagal: ${error.message}`, "error");
        } finally {
          confirmDeleteButton.disabled = false;
          confirmDeleteButton.innerHTML = originalButtonText;
          deleteConfirmationInput.value = "";
          currentProgrammerIdToDelete = null;
        }
      });

      // --- LOGIKA DROPDOWN ---
      const profileButton = document.getElementById("profile-button");
      const profileDropdown = document.getElementById("profile-dropdown");
      const notificationButton = document.getElementById("notification-button");
      const notificationDropdown = document.getElementById("notification-dropdown");

      function closeAllDropdowns() {
        if (!profileDropdown.classList.contains("hidden")) {
          profileDropdown.classList.add("opacity-0", "scale-95");
          setTimeout(() => profileDropdown.classList.add("hidden"), 200);
        }
        if (!notificationDropdown.classList.contains("hidden")) {
          notificationDropdown.classList.add("opacity-0", "scale-95");
          setTimeout(() => notificationDropdown.classList.add("hidden"), 200);
        }
      }

      function toggleDropdown(dropdown) {
        const isHidden = dropdown.classList.contains("hidden");
        closeAllDropdowns();
        if (isHidden) {
          dropdown.classList.remove("hidden");
          setTimeout(() => dropdown.classList.remove("opacity-0", "scale-95"), 10);
        }
      }

      // Logout
      const logoutButton = document.getElementById("logout-button");
      if (logoutButton) {
        logoutButton.addEventListener("click", (e) => {
          e.preventDefault();
          handleLogout();
        });
      }

      profileButton.addEventListener("click", (e) => e.stopPropagation() || toggleDropdown(profileDropdown));
      notificationButton.addEventListener("click", (e) => e.stopPropagation() || toggleDropdown(notificationDropdown));
      window.addEventListener("click", closeAllDropdowns);

      // --- INISIALISASI ---
      document.addEventListener("DOMContentLoaded", fetchInitialData);
    </script>
  </body>
</html>
